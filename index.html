<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="http://jinglebell.parseapp.com/images/ogimage.png"/>
  <meta property="og:description" content="在這個寒冷的季節裡，將頭貼換上一個小丑鼻子暖暖身子吧！" />
  <title>紅色狂想。2015台科大設計系音樂派對</title>
  <link rel="stylesheet" href="css/main.css">
</head>
<body>

  <div class="container">
    <img class="head-pic" src="images/slice1.png" />
    <button id="login">臉書登入</button>

    <a id="download" href="#">下載頭像</a>
    <p>登入臉書，點擊並拖曳綠色條子，用你最喜歡的大小，放在你最喜歡的地方。<br/>換好頭貼，不要忘記，5/7 ─ 5/15，異起用設計，話出台灣心聲<br/>（使用電腦版體驗最佳）</p>
    
    <canvas id="c" width="400" height="400"></canvas>
    <p style="margin-top:50px">設計是需要時間粹練的，花點精神，研究一下要放在哪吧！<br/>如果有 Bug 就重新整理，再 Try 一下，這是一句好話
<br/>Built with great love by <a class="behance" href="https://www.facebook.com/chiunhauyou" target="_blank">宭鎬</a></p>
    

    
  </div>
  
  <script type="text/javascript" src="javascripts/fabric.js"></script>
  <script type="text/javascript">
    //Facebook things

    function statusChangeCallback(response) {
      console.log('statusChangeCallback');
      console.log(response);
      if (response.status === 'connected') {
        // Logged into your app and Facebook.
        testAPI();
      } else if (response.status === 'not_authorized') {
        // The person is logged into Facebook, but not your app.
        document.getElementById('status').innerHTML = 'Please log ' +
          'into this app.';
      } else {
        // The person is not logged into Facebook, so we're not sure if
        // they are logged into this app or not.
        document.getElementById('status').innerHTML = 'Please log ' +
          'into Facebook.';
      }
    }

    function checkLoginState() {
      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    }
    function login() {
      FB.login(function(response) {
        if (response.status === 'connected') {
          checkLoginState()
        } else if (response.status === 'not_authorized') {
          // The person is logged into Facebook, but not your app.
        } else {
          // The person is not logged into Facebook, so we're not sure if
          // they are logged into this app or not.
        }
      }, {scope: 'public_profile'});
    }
    function testAPI() {
      console.log('Welcome!  Fetching your information.... ');
      FB.api('/me/picture?width=400&height=400', function(response) {
        console.log(response.data.url);
        startCanvas(response.data.url);
      });
    }

    function loadImage(src, onload) {
      var img = new Image();
      img.onload = onload;
      img.setAttribute('crossOrigin', 'anonymous');
      img.src = src;

      return img;
    }


    window.fbAsyncInit = function() {
      FB.init({
        appId      : '966974170065904',
        xfbml      : true,
        version    : 'v2.5'
      });

      FB.getLoginStatus(function(response) {
        statusChangeCallback(response);
      });
    };
  

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "//connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));

    function startCanvas(imgURL) {
      var canvas = new fabric.Canvas('c');
      fabric.Image.fromURL(imgURL, function(oImg) {        
        var redFilter = new fabric.Image.filters.Blend({
          color: '#e40076',
          mode: 'lighten'

        });
        oImg.filters.push(redFilter);
        oImg.applyFilters(canvas.renderAll.bind(canvas));
        canvas.add(oImg);

        fabric.Image.fromURL('images/bar.png', function(barImg) {
          canvas.add(barImg);
        },{  
          top: 170,
          left: 80,
          lockUniScaling: true, 
          scaleX: 0.5, 
          scaleY: 0.5,
          cornerColor: '#e40076',
          cornerSize: 16,
          crossOrigin: 'anonymous'})
        // fabric.Image.fromURL('images/filter.png', function(fImg) {
        //   canvas.add(fImg);
        //   var circle = new fabric.Circle({
        //     left: 180,
        //     top: 180,
        //     radius: 25,
        //     fill: 'rgb(233, 75, 70)',
        //     lockUniScaling: true,
        //     lockRotation: true,
        //     stroke: 'white',
        //     strokeWidth: 3,
        //     cornerColor: '#fff'
        //   });
        //   canvas.add(circle);
        // },  { lockMovementX: true, lockMovementY: true , width: 400, height: 400, crossOrigin: 'anonymous'})
        
        
      }, { lockMovementX: true, lockMovementY: true , width: 400, height: 400, crossOrigin: 'anonymous'});
      
      function downloadImage(link, canvasId, filename) {
        link.href = document.getElementById('myCanvas').toDataURL();
        link.download =filename;
      }

      document.getElementById('download').addEventListener('click', function() {
        canvas.deactivateAll().renderAll();  
        // // window.open(canvas.toDataURL('png'));
        // // downloadImage(this, 'myCanvas', 'PrayForSyria.png');
        this.href = canvas.toDataURL('png');
        this.download = 'JingleAllTheWay.png';
      });
    }

    document.getElementById('login').addEventListener('click', function() {
      login();
    });

  </script>
</body>
</html>